<!-- Ensure to first run a local server from the root directory, e.g., npx http-server docs -->
<!--To open the console in Chrome on Mac, press Command + Option + J -->

<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>pose2bvh - Stored Pose Playback</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="three.min.js"></script>
  <script src="bvh_converter.js"></script>

  <script>
    var faceLandmarker;
    var faceResults;
    var holisticResults;

    let camera, scene, renderer, stats;
    var model;
    var animation;
    var animationDuration;
    let camera_bvh, controls_bvh, scene_bvh, renderer_bvh;
    let mixer_bvh, skeletonHelper_bvh;

    var args = window.location.hash.replace("#", "").split(",");
    var fbxfile = args[0] || "ybot.fbx";
    var trackingLine;
    var line_tracker = [];
    // var bvhRecorderFrequency = 20;

    var bvhRecorderFrequency = 30;
    var lastFrameTime = -1;
    var recordStartTime = -1;

    var facemesh;
    var lastUpdateFrameTime = 0;
    var recordedMotionData = [];
    var recording = false;
    var firstFrameJointData;
  </script>

  <style>
    #results {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      color: black;
    }

    #results div {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      max-height: 200px;
      min-height: 200px;
      overflow-y: hidden;
    }
  </style>

</head>

<body style="margin:0;background:#232323">

  <!-- Playback status display -->
  <div id="playbackStatus" style="position:fixed;top:20px;left:20px;color:white;background:rgba(0,0,0,0.7);padding:10px;border-radius:5px;z-index:9999;">
    Loading pose data...
  </div>

  <!-- Playback controls -->
  <div style="position:fixed;top:70px;left:20px;z-index:9999;">
<!--    <button class="btn waves-effect waves-light blue" onclick="window.posePlayer && window.posePlayer.play(false)">-->
<!--      <i class="material-icons" style="vertical-align:middle;">play_arrow</i>-->
    <button id="playOnceBtn" class="btn waves-effect waves-light blue" onclick="window.posePlayer && window.posePlayer.play(false)" disabled>
      <i class="material-icons" style="vertical-align:middle;">play_arrow</i>
      Play Once
    </button>
<!--    <button class="btn waves-effect waves-light orange" onclick="window.posePlayer && window.posePlayer.stop()">-->
<!--      <i class="material-icons" style="vertical-align:middle;">stop</i>-->
    <button id="stopBtn" class="btn waves-effect waves-light orange" onclick="window.posePlayer && window.posePlayer.stop()" disabled>
      <i class="material-icons" style="vertical-align:middle;">stop</i>
      Stop
    </button>
<!--    <button class="btn waves-effect waves-light purple" onclick="window.posePlayer && window.posePlayer.reset()">-->
<!--      <i class="material-icons" style="vertical-align:middle;">replay</i>-->
    <button id="resetBtn" class="btn waves-effect waves-light purple" onclick="window.posePlayer && window.posePlayer.reset()" disabled>
      <i class="material-icons" style="vertical-align:middle;">replay</i>
      Reset
    </button>
<!--    <button id="loopBtn" class="btn waves-effect waves-light grey" onclick="window.posePlayer && window.posePlayer.toggleLoop()">-->
<!--      <i class="material-icons" style="vertical-align:middle;">loop</i>-->
    <button id="loopBtn" class="btn waves-effect waves-light grey" onclick="window.posePlayer && window.posePlayer.toggleLoop()" disabled>
      <i class="material-icons" style="vertical-align:middle;">loop</i>
      Loop
    </button>
  </div>

  <p id="recdetails" style="z-index:9999;position:fixed;bottom:20px;left:5px;color:white;padding:10px;">
    Not Recording...
  </p>

<!--  <button id="recordButton" style="position:absolute; left:0; bottom:0px; z-index: 1001;"-->
<!--      class="main btn waves-effect waves-light green black-text large" onclick="toggleRecording()">-->
<!--      <i class="material-icons" style="vertical-align:middle;font-size:200%">fiber_manual_record</i>-->
  <button id="recordButton" style="position:absolute; left:0; bottom:0px; z-index: 1001;"
      class="main btn waves-effect waves-light green black-text large" onclick="toggleRecording()" disabled>
      <i class="material-icons" style="vertical-align:middle;font-size:200%">fiber_manual_record</i>
      Record BVH
  </button>

  <!-- Load pose player before threejs scene -->
  <script src="pose_player.js"></script>
  <script type="module" src="threejsscene.js"></script>

  <script>
    let isRecording = false;

    // function toggleRecording() {
    //   const recordButton = document.getElementById('recordButton');
    //   const recordIcon = recordButton.querySelector('i');
    //
    //   if (!isRecording) {
    //     // Check if playback is active
    //     if (!window.posePlayer || !window.posePlayer.isPlaying()) {
    //       alert('Please start playback before recording!\n\nTip: Enable "Loop" mode to record multiple passes.');
    //       return;
    //     }
    //
    //     startRecording();
    //     recordButton.classList.remove('green');
    //     recordButton.classList.add('red');
    //     recordIcon.textContent = 'stop';
    //     recordButton.innerHTML = '<i class="material-icons" style="vertical-align:middle;font-size:200%">stop</i> Stop Recording';
    //   } else {
    //     stopRecording();
    //     recordButton.classList.remove('red');
    //     recordButton.classList.add('green');
    //     recordIcon.textContent = 'fiber_manual_record';
    //     recordButton.innerHTML = '<i class="material-icons" style="vertical-align:middle;font-size:200%">fiber_manual_record</i> Record BVH';
    //     recordStartTime = -1;
    //     document.getElementById('recdetails').innerHTML = "Not Recording...";
    //   }
    //
    //   isRecording = !isRecording;
    // }

    function toggleRecording(isAutoStart = false) { // <-- Add the parameter here
  const recordButton = document.getElementById('recordButton');
  const recordIcon = recordButton.querySelector('i');

  if (!isRecording) {
    // Check if playback is active, BUT ONLY if this is NOT an automatic start
    if (!isAutoStart && (!window.posePlayer || !window.posePlayer.isPlaying())) {
      alert('Please start playback before recording!\n\nTip: Enable "Loop" mode to record multiple passes.');
      return;
    }

    startRecording();
    recordButton.classList.remove('green');
    recordButton.classList.add('red');
    recordButton.innerHTML = '<i class="material-icons" style="vertical-align:middle;font-size:200%">stop</i> Stop Recording';
  } else {
    stopRecording();
    recordButton.classList.remove('red');
    recordButton.classList.add('green');
    recordButton.innerHTML = '<i class="material-icons" style="vertical-align:middle;font-size:200%">fiber_manual_record</i> Record BVH';
    recordStartTime = -1;
    document.getElementById('recdetails').innerHTML = "Not Recording...";
  }

  isRecording = !isRecording;
}

// Also, make sure the function is available globally
window.toggleRecording = toggleRecording;

    function startRecording() {
      initialHipPosition = null;
      recording = true;
      recordedMotionData = [];
      recordStartTime = Date.now();
      console.log('Started BVH recording');
    }

    window.startRecording = startRecording; // Expose the function globally

    function stopRecording() {
      recording = false;
      console.log('Stopped BVH recording');

      if (recordedMotionData.length === 0) {
        alert('No frames were recorded!');
        return;
      }

      // Call generateBVH and save the BVH file
      // const bvhContent = generateBVH(firstFrameJointData, recordedMotionData);
      const bvhContent = generateBVH(recordedMotionData[0], recordedMotionData);
      const blob = new Blob([bvhContent], { type: "text/plain;charset=utf-8" });
      const date = new Date();
      const dateString = `${date.getFullYear()}-${date.getMonth() + 1}-${date.getDate()}-${date.getHours()}-${date.getMinutes()}-${date.getSeconds()}`;
      const file_name = `Mocap_bvh_${dateString}.bvh`;
      saveAs(blob, file_name);

      console.log(`Saved ${recordedMotionData.length} frames to ${file_name}`);
    }

    // Make stopRecording globally accessible for pose_player.js
    window.stopRecording = stopRecording;
  </script>

</body>

</html>